<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>
        
            Integer的自动装箱与拆箱
                 
    </title>
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="jacho" />
    <meta name="description" content="Integer的自动装箱与拆箱" />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="/css/violet.css" type="text/css" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="http://feeds.feedburner.com/jachohx" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link href="/css/pygments.css" rel="stylesheet">
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', UA-35504774-1]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body class="post-content">
	<header class="inner"><h1 class="left"><a href="/">DreamCoder</a></h1>
	<div class="right">
		<form class="search right" action="http://google.com/search" method="get">
			<input class="left" type="text" name="q" results="0">
			<input type="hidden" name="q" value="site:">
		</form>
		<div class="social right">
			<a class="facebook" href="http://facebook.com/jachohx" title="Facebook">Facebook</a>
			<a class="google" href="https://plus.google.com" title="Google+">Google+</a>
			<a class="twitter" href="http://" title="Twitter">Twitter</a>
			<a class="github" href="https://" title="GitHub">GitHub</a>
			<a class="rss" href="http://http://feeds.feedburner.com/jachohx" title="RSS">RSS</a>
		</div>
	</div>

	</header>
        <section class="content fn-clear" id="i-am-top">
        <div class="content-cnt">
        <div class="ui-grid-25 ui-grid-right content-top">
            <section class="ui-grid-23 violet-post">
                <div class="v-section-tit">
                    <a href="/" rel="nofollow" >首页</a>
                    <span>&#9830;</span>
                    <h2>Integer的自动装箱与拆箱</h2>
                </div>
                <div class="violet-post-det fn-clear">
                    <div class="ui-grid-15 v-post-detail">
                        <div class="v-entry">
                            <h1 class="title">Integer的自动装箱与拆箱</h1>
                            <p class="meta"><time class="date" pubdate="2012-11-16">2012-11-16</time> By <a href="/contact.html" class="author" title="author">jacho</a>
							<label>分类</label>
							
								<a href="#/category/tech">技术</a>
							
							<label>标签</label>
							
								<a href="#/tag/java">java</a>
							</p>
                            <p class="description">Integer的自动装箱与拆箱</p>
                            <p>最近看到一行代码</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">));</span>
</code></pre></div>
<p>Map是HashMap<String, Integer>();</p>

<p>首先这行代码效率肯定是很低的，1是数字，然后转成了字符，再转成数字。</p>

<p>首先，既然是数字，那么就没有必要用“1”了，直接Integer.valueOf(1)就可以了。</p>

<p>最简单的写法是1。</p>

<p>但考虑到自动装箱boxing 是在JDK1.5后才有的，所以1.4还是要用new Integer(1)或Integer(1)。</p>

<!--more-->

<p>下面来看下这段代码</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Integer</span> <span class="n">i1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="n">Integer</span> <span class="n">i2</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Integer</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">Integer</span> <span class="n">i3</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>    
<span class="n">Integer</span> <span class="n">i4</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">);</span>
<span class="n">Integer</span> <span class="n">i5</span> <span class="o">=</span> <span class="mi">129</span><span class="o">;</span>       
<span class="kt">int</span> <span class="n">i6</span> <span class="o">=</span> <span class="n">i5</span><span class="o">;</span>
</code></pre></div>
<p>在Class文件里可以看到</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="mi">0</span>  <span class="n">iconst_1</span>
<span class="mi">1</span>  <span class="n">invokestatic</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span> <span class="o">[</span><span class="mi">16</span><span class="o">]</span>
<span class="mi">4</span>  <span class="n">astore_1</span> <span class="o">[</span><span class="n">i1</span><span class="o">]</span>
<span class="mi">5</span>  <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span> <span class="o">[</span><span class="mi">17</span><span class="o">]</span>
<span class="mi">8</span>  <span class="n">dup</span>
<span class="mi">9</span>  <span class="n">iconst_1</span>
<span class="mi">10</span>  <span class="n">invokespecial</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">[</span><span class="mi">22</span><span class="o">]</span>
<span class="mi">13</span>  <span class="n">astore_2</span> <span class="o">[</span><span class="n">i2</span><span class="o">]</span>
<span class="mi">14</span>  <span class="n">iconst_1</span>
<span class="mi">15</span>  <span class="n">invokestatic</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span> <span class="o">[</span><span class="mi">16</span><span class="o">]</span>
<span class="mi">18</span>  <span class="n">astore_3</span> <span class="o">[</span><span class="n">i3</span><span class="o">]</span>
<span class="mi">19</span>  <span class="n">ldc</span> <span class="o">&lt;</span><span class="n">String</span> <span class="s">&quot;1&quot;</span><span class="o">&gt;</span> <span class="o">[</span><span class="mi">25</span><span class="o">]</span>
<span class="mi">21</span>  <span class="n">invokestatic</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span> <span class="o">[</span><span class="mi">27</span><span class="o">]</span>
<span class="mi">24</span>  <span class="n">astore</span> <span class="mi">4</span> <span class="o">[</span><span class="n">i4</span><span class="o">]</span>
<span class="mi">26</span>  <span class="n">sipush</span> <span class="mi">129</span>
<span class="mi">29</span>  <span class="n">invokestatic</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span> <span class="o">[</span><span class="mi">16</span><span class="o">]</span>
<span class="mi">32</span>  <span class="n">astore</span> <span class="mi">5</span> <span class="o">[</span><span class="n">i5</span><span class="o">]</span>
<span class="mi">34</span>  <span class="n">aload</span> <span class="mi">5</span> <span class="o">[</span><span class="n">i5</span><span class="o">]</span>
<span class="mi">36</span>  <span class="n">invokevirtual</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Integer</span><span class="o">.</span><span class="na">intValue</span><span class="o">()</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">[</span><span class="mi">30</span><span class="o">]</span>
<span class="mi">39</span>  <span class="n">istore</span> <span class="mi">6</span> <span class="o">[</span><span class="n">i6</span><span class="o">]</span>
</code></pre></div>
<p>i1是1，JDK会自动装箱boxing，调用Integer.valueOf(int)方法。与i3是一样的效果。</p>

<p>而i2是直接new 一个新的Integer。</p>

<p>i4也调用了valueOf方法，不过比valueOf(int)多了一个步骤parseInt(s, 10)。</p>

<p>i5与i1一样，不过还是有一点区别，等下再看下valueOf的方法。</p>

<p>i6是一个自动拆箱unboxing，调用Integer.intValue方法。</p>

<p>下面再来看下valueOf(int)这个方法</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">128</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// must cache </span>
        <span class="k">return</span> <span class="n">IntegerCache</span><span class="o">.</span><span class="na">cache</span><span class="o">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="o">];</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Integer</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>在看下IntegerCache</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IntegerCache</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">IntegerCache</span><span class="o">(){}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">cache</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">[-(-</span><span class="mi">128</span><span class="o">)</span> <span class="o">+</span> <span class="mi">127</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cache</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
        <span class="n">cache</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Integer</span><span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">128</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>IntegerCache会对-128~127之间的数做一个缓存，在valueOf方法里，对-128~127之间的数直接使用IntegerCache缓存，不在这个范围的，则new Integer(int)方法。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">127</span><span class="o">)</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">127</span><span class="o">));</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">129</span><span class="o">)</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">129</span><span class="o">));</span>
</code></pre></div>
<p>这两个的输出是true，false，也就是第一个用了缓存，第二个都是new出来的对象。</p>

<p>所以最开始那个代码可以使用</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
</code></pre></div>
<p>当然为了兼容1.4那么就写成</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</code></pre></div>
<p>​ </p>

<p>但最好不要用</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Integer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
</code></pre></div>
                        </div>
                        <nav class="v-pagination">
                            
                            <a class="prev" href="/post/github-pages.html" rel="bookmark">&laquo;&nbsp;使用Github Pages建独立博客</a>
                            
                            
                            <a class="next" href="/post/jekyll-rsync.html" rel="bookmark">用vps写jekyll&nbsp;&raquo;</a>
                            
                         </nav>
                         <div class="violet-comment">
                             <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'jachohx'; // required: replace example with your forum shortname
	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
                         </div><!-- //violet-comment -->
                    </div>                   
                </div>
            </section><!-- //violet-post -->
        </div>
        </div>
    </section><!-- //content -->

    <a class="v-fork-me" href="https://github.com/jachohx" target="_blank" rel="nofollow">
        <img src="/images/forkme.png" alt="Fork me on GitHub">
    </a>
</body>
</html>
